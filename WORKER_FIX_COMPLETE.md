# ðŸ”§ Fix Cloudflare Worker CORS and Connection Issues

The NetworkError suggests the Cloudflare Worker isn't properly configured. Here's the complete solution:

## ðŸš¨ **Root Cause Analysis**

The issue is likely:
1. **Missing CORS headers** in the Cloudflare Worker
2. **Worker not handling OPTIONS preflight** requests
3. **Incorrect request handling** in the Worker

## ðŸ”§ **Complete Cloudflare Worker Code**

Replace your entire Cloudflare Worker code with this:

```javascript
// Cloudflare Worker for AI Mockup Generator
addEventListener('fetch', event => {
  event.respondWith(handleRequest(event.request))
})

async function handleRequest(request) {
  // Handle CORS preflight requests
  if (request.method === 'OPTIONS') {
    return new Response(null, {
      status: 200,
      headers: {
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
        'Access-Control-Allow-Headers': 'Content-Type, Authorization',
        'Access-Control-Max-Age': '86400',
      }
    })
  }

  // Handle GET requests (health check)
  if (request.method === 'GET') {
    return new Response(JSON.stringify({
      status: 'ok',
      message: 'AI Mockup Generator Worker is running',
      timestamp: new Date().toISOString()
    }), {
      status: 200,
      headers: {
        'Content-Type': 'application/json',
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
        'Access-Control-Allow-Headers': 'Content-Type, Authorization',
      }
    })
  }

  // Handle POST requests (mockup generation)
  if (request.method === 'POST') {
    try {
      const { image, note } = await request.json()
      
      if (!image || !note) {
        return new Response(JSON.stringify({
          success: false,
          error: 'Missing image or note'
        }), {
          status: 400,
          headers: {
            'Content-Type': 'application/json',
            'Access-Control-Allow-Origin': '*',
          }
        })
      }

      // Call Google Gemini API
      const result = await generateMockup(image, note)
      
      return new Response(JSON.stringify(result), {
        status: 200,
        headers: {
          'Content-Type': 'application/json',
          'Access-Control-Allow-Origin': '*',
          'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
          'Access-Control-Allow-Headers': 'Content-Type, Authorization',
        }
      })
      
    } catch (error) {
      console.error('Worker error:', error)
      return new Response(JSON.stringify({
        success: false,
        error: error.message
      }), {
        status: 500,
        headers: {
          'Content-Type': 'application/json',
          'Access-Control-Allow-Origin': '*',
        }
      })
    }
  }

  // Handle other methods
  return new Response('Method not allowed', { status: 405 })
}

async function generateMockup(imageBase64, designNote) {
  const GEMINI_API_KEY = 'YOUR_GEMINI_API_KEY_HERE' // Replace with your actual API key
  const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-pro-vision:generateContent'
  
  try {
    const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        contents: [{
          parts: [
            { 
              text: `Generate a product mockup based on this uploaded image and design instructions: ${designNote}. Create a realistic product mockup that incorporates the uploaded image with the specified design elements.` 
            },
            { 
              inline_data: { 
                mime_type: 'image/jpeg', 
                data: imageBase64 
              } 
            }
          ]
        }],
        generationConfig: {
          temperature: 0.7,
          topK: 40,
          topP: 0.95,
          maxOutputTokens: 1024,
        }
      })
    })

    if (!response.ok) {
      const errorText = await response.text()
      throw new Error(`Gemini API error: ${response.status} - ${errorText}`)
    }

    const result = await response.json()
    
    // Extract the generated image URL or text from the response
    if (result.candidates && result.candidates[0] && result.candidates[0].content) {
      const content = result.candidates[0].content.parts[0].text
      
      // For now, return a placeholder URL - you'll need to implement image generation
      return {
        success: true,
        mockupUrl: 'https://via.placeholder.com/400x400/95bf47/ffffff?text=Mockup+Generated',
        content: content
      }
    } else {
      throw new Error('No content generated by Gemini API')
    }
    
  } catch (error) {
    console.error('Gemini API error:', error)
    throw error
  }
}
```

## ðŸ”‘ **Environment Variables**

In your Cloudflare Worker dashboard:

1. **Go to**: Workers & Pages â†’ Your Worker â†’ Settings â†’ Variables
2. **Add environment variable**:
   - **Variable name**: `GEMINI_API_KEY`
   - **Value**: Your actual Google Gemini API key
3. **Save and redeploy**

## ðŸ§ª **Testing Steps**

### **1. Test Worker Directly**
Visit: `https://arotags-ai-mockup-generator.mmilam360.workers.dev/`
- Should return: `{"status":"ok","message":"AI Mockup Generator Worker is running",...}`

### **2. Test with curl**
```bash
curl -X GET https://arotags-ai-mockup-generator.mmilam360.workers.dev/
```

### **3. Test POST Request**
```bash
curl -X POST https://arotags-ai-mockup-generator.mmilam360.workers.dev/ \
  -H "Content-Type: application/json" \
  -d '{"image":"test","note":"test"}'
```

### **4. Test from Browser**
- Go to your app: `https://a6a3aa46.shopify-app-image-generation.pages.dev/`
- Click "Test Connection to Worker"
- Should show: âœ… Connection test successful!

## ðŸš¨ **Common Issues & Solutions**

### **Issue 1: CORS Error**
- **Solution**: Ensure CORS headers are set on ALL responses
- **Check**: Worker returns `Access-Control-Allow-Origin: *`

### **Issue 2: OPTIONS Request Failing**
- **Solution**: Handle OPTIONS method explicitly
- **Check**: Worker responds to OPTIONS with 200 status

### **Issue 3: API Key Not Working**
- **Solution**: Verify API key in environment variables
- **Check**: Test Gemini API directly with curl

### **Issue 4: Request Format Wrong**
- **Solution**: Ensure request body matches expected format
- **Check**: Worker logs show proper JSON parsing

## ðŸŽ¯ **Next Steps**

1. **Replace your Worker code** with the code above
2. **Set the GEMINI_API_KEY** environment variable
3. **Redeploy the Worker**
4. **Test the connection** from your app
5. **Check browser console** for any remaining errors

The key is ensuring CORS headers are present on ALL responses and the Worker properly handles OPTIONS preflight requests.
